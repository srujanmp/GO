<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Audio Streaming</title>
</head>
<body>
  <h1>Real-Time Audio Streaming</h1>
  <script>
    // Connect to WebSocket server
    const ws = new WebSocket('ws://x.eventshub.tech:8080/socket'); // Replace with your Go server's WebSocket URL

    // AudioContext setup
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const sampleRate = 8000; // μ-law encoded audio is typically 8 kHz
    const bufferSize = 1024; // Size of audio buffer for smooth playback
    const audioBufferQueue = [];

    // μ-law decoding lookup table
    const muLawDecodeTable = new Int16Array(256);
    for (let i = 0; i < 256; i++) {
      const sign = (i & 0x80) ? -1 : 1;
      const exponent = (i >> 4) & 0x07;
      const mantissa = i & 0x0F;
      const magnitude = (1 << exponent) + (mantissa << (exponent + 3));
      muLawDecodeTable[i] = sign * magnitude;
    }

    // Decode μ-law to PCM
    function decodeMuLawChunk(chunk) {
      const decoded = new Float32Array(chunk.length);
      for (let i = 0; i < chunk.length; i++) {
        decoded[i] = muLawDecodeTable[chunk[i]] / 32768; // Normalize to -1.0 to 1.0
      }
      return decoded;
    }

    // Append decoded audio to buffer queue
    function appendToBuffer(decodedChunk) {
      audioBufferQueue.push(decodedChunk);
    }

    // Audio playback loop
    function playbackLoop() {
      if (audioBufferQueue.length > 0) {
        const buffer = audioBufferQueue.shift();
        const audioBuffer = audioContext.createBuffer(1, buffer.length, sampleRate);
        audioBuffer.copyToChannel(buffer, 0, 0);

        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start();
      }
      setTimeout(playbackLoop, 20); // Call the loop every 20ms
    }

    // Start playback loop when WebSocket opens
    ws.onopen = () => {
      console.log('WebSocket connected');
      playbackLoop();
    };

    // Handle incoming audio data
    ws.onmessage = (event) => {
      const chunk = new Uint8Array(event.data);
      const decodedChunk = decodeMuLawChunk(chunk);
      appendToBuffer(decodedChunk);
    };

    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };

    ws.onclose = () => {
      console.log('WebSocket disconnected');
    };
  </script>
</body>
</html>
