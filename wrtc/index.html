<!DOCTYPE html>
<html>
<head>
    <title>WebRTC</title>
    <style>
        #playPauseButton {
            display: none;
        }
    </style>
</head>
<body>
    <button id="playPauseButton">Play</button>
    <div id="status">Connecting...</div>
    <audio id="audioPlayer" autoplay ></audio>

    <script>
        let isPlaying = false;
        let conn = null;
        let ws = new WebSocket('ws://localhost:8080/websocket');
        let audioElement = document.getElementById('audioPlayer');
        let audioStream = null;

        const playPauseButton = document.getElementById('playPauseButton');
        const statusElement = document.getElementById('status');

        //setup webrtc using ws
        ws.onopen = () => {
            console.log("connected");
            statusElement.textContent = "Establishing connection...";
            setupWebRTC();
        };

        ws.onerror = () => {
            statusElement.textContent = "Connection failed. Please try again later.";
        };

        //setup webrtc
        async function setupWebRTC() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };

            conn = new RTCPeerConnection(configuration);

            conn.ontrack = (event) => {
                console.log('audio track received:', event.track);
                audioStream = event.streams[0];
                audioElement.srcObject = audioStream;
                // Show button when audio track is received
                statusElement.style.display = 'none';
                playPauseButton.style.display = 'block';
            };

            conn.addEventListener("icegatheringstatechange", (event) => {
                console.log('ICE gathering state change:', conn.iceGatheringState);
                if (conn.iceGatheringState === 'complete') {
                  console.log('ICE gathering  complete. Sending offer to server');
                  statusElement.textContent = "Preparing audio stream...";
                  ws.send(JSON.stringify({
                      type: 'offer',
                      sdp: conn.localDescription
                  }));
                }
            });

            conn.addTransceiver('audio', {
                direction: 'recvonly',
                sendEncodings: [{ maxBitrate: 64000 }]
            });

            const offer = await conn.createOffer();
            await conn.setLocalDescription(offer);
        }

        //play pause logic
        playPauseButton.addEventListener('click', async () => {
            try {
                isPlaying = !isPlaying;

                if (isPlaying) {
                    playPauseButton.textContent = 'Pause';
                    ws.send('PLAY');
                    audioElement.play();
                } else {
                    playPauseButton.textContent = 'Play';
                    ws.send('PAUSE');
                    audioElement.pause();
                }
            } catch (error) {
                console.error('Error handling play/pause:', error);
                isPlaying = false;
                playPauseButton.textContent = 'Play';
            }
        });

        ws.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'answer') {
                await conn.setRemoteDescription(message.sdp);
                console.log('Received and set remote description');
            }
        };
    </script>
</body>
</html>







